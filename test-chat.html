<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… ì—°ê²° í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            padding: 40px;
            background: #f5f7fa;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 {
            color: #667eea;
            margin-bottom: 20px;
        }
        .status {
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .status.disconnected {
            background: #ffebee;
            color: #c62828;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .log {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .log div {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        button {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Socket.io ì—°ê²° í…ŒìŠ¤íŠ¸</h1>

        <div id="status" class="status disconnected">
            âŒ ì—°ê²° ì¤‘...
        </div>

        <div>
            <button onclick="testConnection()">ğŸ”„ ì—°ê²° ì¬ì‹œë„</button>
            <button onclick="testJoinRoom()">ğŸšª ë°© ì°¸ê°€ í…ŒìŠ¤íŠ¸</button>
            <button onclick="testSendMessage()">ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>

        <h2>ğŸ“‹ ì—°ê²° ë¡œê·¸</h2>
        <div id="log" class="log"></div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let socket;
        let logDiv = document.getElementById('log');
        let statusDiv = document.getElementById('status');

        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            div.textContent = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            div.style.color = type === 'error' ? '#c62828' : type === 'success' ? '#155724' : '#333';
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(text, connected) {
            statusDiv.textContent = text;
            statusDiv.className = 'status ' + (connected ? 'connected' : 'disconnected');
        }

        function initSocket() {
            addLog('Socket.io ì´ˆê¸°í™” ì‹œì‘...', 'info');

            socket = io('http://3.35.139.224', {
                path: '/socket.io',
                transports: ['polling', 'websocket'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 10,
                timeout: 20000
            });

            socket.on('connect', () => {
                addLog(`ì—°ê²° ì„±ê³µ! Socket ID: ${socket.id}`, 'success');
                updateStatus('âœ… ì—°ê²°ë¨', true);
            });

            socket.on('disconnect', (reason) => {
                addLog(`ì—°ê²° ëŠê¹€. ì´ìœ : ${reason}`, 'error');
                updateStatus('âŒ ì—°ê²° ëŠê¹€', false);
            });

            socket.on('connect_error', (error) => {
                addLog(`ì—°ê²° ì˜¤ë¥˜: ${error.message}`, 'error');
                addLog(`ì˜¤ë¥˜ ìƒì„¸: ${error.toString()}`, 'error');
                updateStatus('âš ï¸ ì—°ê²° ì˜¤ë¥˜', false);
            });

            socket.on('reconnect', (attemptNumber) => {
                addLog(`ì¬ì—°ê²° ì„±ê³µ (ì‹œë„ ${attemptNumber}íšŒ)`, 'success');
            });

            socket.on('reconnect_attempt', (attemptNumber) => {
                addLog(`ì¬ì—°ê²° ì‹œë„ ì¤‘... (${attemptNumber}íšŒ)`, 'info');
            });

            socket.on('receive_message', (data) => {
                addLog(`ë©”ì‹œì§€ ìˆ˜ì‹ : [${data.user_name}] ${data.message}`, 'success');
            });

            socket.on('chat_history', (messages) => {
                addLog(`ì±„íŒ… íˆìŠ¤í† ë¦¬ ìˆ˜ì‹ : ${messages.length}ê°œ ë©”ì‹œì§€`, 'success');
            });

            socket.on('user_joined', (data) => {
                addLog(`ì‚¬ìš©ì ì…ì¥: ${data.user_name} (${data.user_type})`, 'info');
            });

            socket.on('user_left', (data) => {
                addLog(`ì‚¬ìš©ì í‡´ì¥: ${data.user_name} (${data.user_type})`, 'info');
            });
        }

        function testConnection() {
            addLog('=== ì—°ê²° ì¬ì‹œë„ ===', 'info');
            if (socket) {
                socket.disconnect();
            }
            setTimeout(initSocket, 500);
        }

        function testJoinRoom() {
            if (!socket || !socket.connected) {
                addLog('ë¨¼ì € ì„œë²„ì— ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤!', 'error');
                return;
            }
            addLog('=== ë°© ì°¸ê°€ í…ŒìŠ¤íŠ¸ ===', 'info');
            socket.emit('join_room', {
                room_id: 'general',
                user_name: 'í…ŒìŠ¤íŠ¸ì‚¬ìš©ì',
                user_type: 'student'
            });
            addLog('ë°© ì°¸ê°€ ìš”ì²­ ì „ì†¡ ì™„ë£Œ', 'success');
        }

        function testSendMessage() {
            if (!socket || !socket.connected) {
                addLog('ë¨¼ì € ì„œë²„ì— ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤!', 'error');
                return;
            }
            addLog('=== ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸ ===', 'info');
            socket.emit('send_message', {
                room_id: 'general',
                message: 'í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤!'
            });
            addLog('ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ', 'success');
        }

        function clearLog() {
            logDiv.innerHTML = '';
            addLog('ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.', 'info');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì—°ê²°
        window.onload = function() {
            addLog('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'info');
            addLog('ì„œë²„ URL: http://3.35.139.224', 'info');
            addLog('Socket.io ê²½ë¡œ: /socket.io', 'info');
            initSocket();
        };
    </script>
</body>
</html>
